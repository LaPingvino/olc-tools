<!doctype html>
<html>
    <head>
        <title>
            whenwhere.uk - Dead simple lightweight communication and
            coordination
        </title>
        <script>
            if (
                window.location.protocol.substring(0, 5) != "https" &&
                (window.location.hostname == "whenwhere.uk" ||
                    window.location.hostname == "www.whenwhere.uk" ||
                    window.location.hostname == "donde.ir" ||
                    window.location.hostname == "www.donde.ir")
            ) {
                window.location.protocol = "https:";
            }
        </script>
        <script src="hivejs.min.js"></script>
        <script src="markdown.min.js"></script>
        <script src="localmessages.js"></script>
        <script src="openlocationcode.min.js"></script>
        <meta name="viewport" content="initial-scale=1" />
        <meta name="theme-color" value="#f8f9fa" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="apple-mobile-web-app-title" content="WhenWhere.uk" />
        <link rel="apple-touch-icon" href="/images/icons/icon-152x152.png" />
        <link rel="manifest" href="manifest.json" />
        <link rel="canonical" href="https://whenwhere.uk" />
        <style>
            @import url("https://fonts.googleapis.com/css?family=Roboto+Slab:400,700&display=swap");

            :root {
                --primary-color: #007bff;
                --secondary-color: #6c757d;
                --light-gray: #f8f9fa;
                --dark-gray: #343a40;
                --border-color: #dee2e6;
                --text-color: #212529;
                --link-color: #007bff;
                --link-hover-color: #0056b3;
            }

            body {
                font-family: "Roboto Slab", serif;
                font-size: 16px;
                line-height: 1.6;
                color: var(--text-color);
                background-color: var(--light-gray);
                margin: 0;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                box-sizing: border-box;
            }

            .container {
                background-color: white;
                padding: 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 700px;
                margin-bottom: 20px;
            }

            h1 {
                font-size: 2.5em;
                color: var(--primary-color);
                text-align: center;
                margin-top: 0;
                margin-bottom: 20px;
            }

            #nowat,
            #shortcode,
            #accuracy {
                color: var(--secondary-color);
                font-size: 0.9em;
                text-align: center;
                margin-bottom: 10px;
            }

            #code {
                font-size: 2.8em; /* Slightly reduced for better fit */
                font-weight: 700;
                color: var(--primary-color);
                text-align: center;
                margin: 10px 0 15px;
                padding: 10px;
                background-color: var(--light-gray);
                border-radius: 4px;
                cursor: pointer;
                word-break: break-all; /* Ensure long codes don't overflow */
                user-select: all;
            }

            #code:hover {
                background-color: #e9ecef;
            }

            #local {
                font-weight: 700; /* Already bold, but explicit */
            }

            #nav {
                text-align: center;
                margin: 20px 0;
                padding: 15px;
                background-color: #f8f9fa;
                border-radius: 6px;
                border: 1px solid var(--border-color);
            }

            #navinput {
                font-family: "Roboto Slab", serif;
                font-size: 1em;
                padding: 10px 15px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                width: calc(100% - 32px); /* Full width with padding */
                max-width: 250px; /* Max width for larger screens */
                margin: 10px auto;
                display: block;
                box-sizing: border-box;
            }

            #navinput:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            }

            #nav1,
            #nav2 {
                display: block;
                margin-bottom: 5px;
                font-size: 0.95em;
            }
            #nav2 {
                color: var(--secondary-color);
                font-size: 0.85em;
            }

            hr {
                border: 0;
                height: 1px;
                background-color: var(--border-color);
                margin: 30px 0;
            }

            #more,
            #source {
                font-size: 0.9em;
                color: var(--secondary-color);
                line-height: 1.7;
            }

            #more b {
                color: var(--dark-gray);
                display: block;
                margin-bottom: 8px;
                font-size: 1.1em;
            }

            #more a,
            #source a {
                color: var(--link-color);
                text-decoration: none;
                font-weight: 700;
            }

            #more a:hover,
            #source a:hover {
                color: var(--link-hover-color);
                text-decoration: underline;
            }

            #messages {
                margin-top: 20px;
                padding: 15px;
                background-color: #f8f9fa;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                min-height: 100px;
            }

            .message {
                margin: 10px 0;
                padding: 15px;
                border: 1px solid var(--border-color);
                border-left: 4px solid var(--primary-color);
                background-color: white;
                border-radius: 4px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            #source {
                text-align: center;
                margin-top: 30px;
                font-size: 0.8em;
            }

            /* Utility class for small text */
            .text-muted {
                color: var(--secondary-color);
            }

            /* Responsive adjustments */
            @media (max-width: 600px) {
                body {
                    padding: 10px;
                }
                .container {
                    padding: 15px;
                }
                #code {
                    font-size: 2.2em;
                }
                h1 {
                    font-size: 2em;
                }
                #navinput {
                    width: 100%; /* Full width on small screens */
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>WhenWhere.uk</h1>
            <div id="nowat">You are at:</div>
            <div
                id="code"
                onclick="share(this.title)"
                title="Click to share this code"
            >
                <span id="region">0000</span><wbr /><span id="local"
                    >0000+00</span
                >
            </div>
            <div id="accuracy" class="text-muted">
                Please be patient. If this stays here too long, something is
                wrong.
            </div>
            <div id="shortcode" class="text-muted">
                If someone is already close to you, the bold last part of the
                code is enough.
            </div>

            <div id="nav">
                <span id="nav1">Go to:</span>
                <input
                    id="navinput"
                    placeholder="Enter OLC (e.g., 8FXC2222+22)"
                    type="text"
                />
                <span id="nav2">(enter OLC)</span>
            </div>

            <hr />

            <div id="more">
                <b>Do more with this code:</b>
                <p>
                    <a
                        id="navapp"
                        href="https://www.google.com/maps/@?api=1&map_action=map"
                        >Navigate with a map app</a
                    >, look at the
                    <a id="map" href="https://plus.codes/map/"
                        >full map around the OLC</a
                    >, do a
                    <a
                        id="refhref"
                        href="https://nominatim.openstreetmap.org/reverse.php?format=html&zoom=12"
                        >reverse lookup</a
                    >
                    to get possible reference points to get people to the right
                    region first.
                </p>
                <p>
                    Want more info?
                    <a href="https://plus.codes"
                        >Get the full story about Plus-codes</a
                    >. There is also a
                    <a href="precise.html"
                        >more precise version for e.g. slum navigation</a
                    >.
                </p>
            </div>

            <hr />

            <div id="messages">
                Here you will see messages of people around you...
            </div>
        </div>

        <div id="source">
            Although the code is ugly, it's open source. Find it on
            <a href="https://github.com/lapingvino/olc-tools/"
                >lapingvino/olc-tools</a
            >
            on Github.
        </div>

        <script>
            document.getElementById("navinput").value =
                localStorage.getItem(location.pathname) ||
                location.hash.substring(1);
            nav2default = document.getElementById("nav2").innerHTML;
            function dist(lat1, lon1, lat2, lon2) {
                var R = 6371; // Radius of the earth in km
                var dLat = deg2rad(lat2 - lat1); // deg2rad below
                var dLon = deg2rad(lon2 - lon1);
                var a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(deg2rad(lat1)) *
                        Math.cos(deg2rad(lat2)) *
                        Math.sin(dLon / 2) *
                        Math.sin(dLon / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c; // Distance in km
                return Math.floor(d * 1000); //return round distance in meters
            }

            function dirfunc(lat1, long1, lat2, long2) {
                t = 0.000125;
                n = lat1 - lat2;
                e = long1 - long2;
                if (Math.abs(e) > 90) {
                    e = -e;
                } // Correct for longitude wrapping
                ns = n > 0 ? "south" : "north";
                es = e > 0 ? "west" : "east"; // Corrected: if e is positive, it's east of you, so you go west. This logic might be reversed based on intent. Assuming (lat2,long2) is destination.
                // If e = long1 - long2 > 0, then long1 > long2, so destination is to the west.
                r = "";
                // Displaying "units" or "steps" might be more intuitive than raw coordinate differences.
                // For simplicity, keeping the original logic but with better emoji if available.
                // Using walking person emoji: \u{1F6B6}
                if (Math.abs(n) > t) {
                    r +=
                        Math.floor(Math.abs(n) * 100000) +
                        " \u{1F6B6} " +
                        ns +
                        " ";
                }
                if (Math.abs(e) > t) {
                    r +=
                        Math.floor(Math.abs(e) * 100000) +
                        " \u{1F6B6} " +
                        es +
                        " ";
                }
                if (r == "") {
                    r = "You've arrived! \u{1F3C1}";
                } // Added a flag emoji
                return r;
            }

            function share(code) {
                var webShare = "share" in navigator;
                if (webShare) {
                    // Use Web Share API
                    document.getElementById("code").addEventListener(
                        "click",
                        () => {
                            navigator
                                .share({
                                    title: "My WhenWhere.uk Location",
                                    text:
                                        "My current location code is: " +
                                        code +
                                        ". Join me or see where I am!",
                                    url:
                                        location.href.match(/^[^#]*/)[0] +
                                        "#" +
                                        code,
                                })
                                .then(() => console.log("Shared successfully"))
                                .catch((error) =>
                                    console.error("Error sharing:", error),
                                );
                        },
                        { once: true },
                    ); // Attach the event listener only once
                } else {
                    // Fallback for browsers that don't support Web Share API
                    // Prompt user to copy the link or code
                    document.getElementById("code").addEventListener(
                        "click",
                        () => {
                            // Select the text
                            const range = document.createRange();
                            range.selectNode(document.getElementById("code"));
                            window.getSelection().removeAllRanges();
                            window.getSelection().addRange(range);

                            try {
                                // Now that we've selected the text, let's copy it
                                document.execCommand("copy");
                                alert("Code copied to clipboard!");
                            } catch (err) {
                                console.error("Failed to copy: ", err);
                                alert(
                                    "Sharing not supported on this browser. Your code is: " +
                                        code +
                                        "\nURL: " +
                                        location.href.match(/^[^#]*/)[0] +
                                        "#" +
                                        code +
                                        "\nPlease copy it manually.",
                                );
                            }
                        },
                        { once: true },
                    ); // Attach the event listener only once
                }
            }

            function resolve(code, lat, lon) {
                // Ensure code is a string and not empty.
                if (typeof code !== "string" || code.trim() === "") {
                    return null;
                }
                const upperCode = code.trim().toUpperCase();

                try {
                    // OpenLocationCode.recoverNearest can handle full codes and short codes.
                    // It will throw an error for badly formed codes.
                    let recoveredFullCode = OpenLocationCode.recoverNearest(
                        upperCode,
                        lat,
                        lon,
                    );
                    // OpenLocationCode.decode then gets the coordinates object.
                    return OpenLocationCode.decode(recoveredFullCode);
                } catch (e) {
                    // This catch block will handle errors from recoverNearest (e.g., invalid code format)
                    // or from decode (though less likely if recoverNearest succeeds).
                    // Log this as a warning, as it's often due to user input.
                    console.warn(
                        "OLC resolve/decode error for input '" +
                            upperCode +
                            "': " +
                            e.message,
                    );
                    return null;
                }
            }

            function deg2rad(deg) {
                return deg * (Math.PI / 180);
            }
            dot = "."; // This is used for a subtle animation/indicator
            navigator.geolocation.watchPosition(
                function (position) {
                    // Renamed location to position for clarity
                    length = 4; // Default OLC length
                    if (dot == "") {
                        dot = ".";
                    } else {
                        dot = "";
                    } // Toggle dot for visual feedback

                    let coords = position.coords; // Cache coords
                    acc = coords.accuracy;

                    // Determine OLC length based on accuracy
                    if (acc < 15) {
                        // Very high accuracy
                        length = 11;
                    } else if (acc < 300) {
                        // Good accuracy
                        length = 10;
                    } else if (acc < 6000) {
                        // Medium accuracy
                        length = 8;
                    } else if (acc < 120000) {
                        // Low accuracy
                        length = 6;
                    }
                    // else length remains 4 (very low accuracy / region only)

                    currentOlc = OpenLocationCode.encode(
                        coords.latitude,
                        coords.longitude,
                        length,
                    );

                    document.getElementById("code").title = currentOlc; // Set title for share function
                    document.getElementById("region").innerHTML =
                        currentOlc.substring(0, 4);
                    document.getElementById("local").innerHTML =
                        currentOlc.substring(4);
                    document.getElementById("accuracy").innerHTML =
                        "Accuracy: within " +
                        Math.floor(acc) +
                        " meters " +
                        dot;

                    // Update links with current location/navigation info
                    let navInputValue = document
                        .getElementById("navinput")
                        .value.trim(); // Keep original case for some uses, but use toUpperCase for OLC logic

                    let navInputUpper = navInputValue.toUpperCase();

                    document.getElementById("map").href =
                        "https://plus.codes/map/" +
                        (navInputUpper || currentOlc); // Use current OLC if input is empty
                    document.getElementById("refhref").href =
                        "https://nominatim.openstreetmap.org/reverse.php?format=html&lat=" +
                        coords.latitude +
                        "&lon=" +
                        coords.longitude +
                        "&zoom=18"; // Increased zoom for more detail

                    try {
                        if (navInputValue) {
                            // Check if original trimmed input value is not empty
                            // Only process if there's something in navinput
                            let destination = resolve(
                                navInputUpper, // Use upper case for resolving
                                coords.latitude,
                                coords.longitude,
                            );
                            if (destination) {
                                let destinationOlc = OpenLocationCode.encode(
                                    destination.latitudeCenter,
                                    destination.longitudeCenter,
                                    // Use the codeLength from the decoded OLC object for better precision
                                    Math.max(6, destination.codeLength),
                                );
                                document.getElementById("navapp").href =
                                    "https://www.google.com/maps/dir/?api=1&destination=" +
                                    encodeURIComponent(navInputValue); // Use original input for nav

                                let distance = dist(
                                    coords.latitude,
                                    coords.longitude,
                                    destination.latitudeCenter,
                                    destination.longitudeCenter,
                                );
                                let direction = dirfunc(
                                    coords.latitude,
                                    coords.longitude,
                                    destination.latitudeCenter,
                                    destination.longitudeCenter,
                                );
                                document.getElementById("nav2").innerHTML =
                                    `Target is ~${distance}m away (${direction})`;

                                if (
                                    location.hash.substring(1) !== navInputValue // Compare with original input for hash
                                ) {
                                    location.hash = navInputValue; // Set hash to original input
                                }
                                localStorage.setItem(
                                    location.pathname,
                                    navInputValue, // Store original input
                                );
                                messages(
                                    "geo" + destinationOlc.substring(0, 6),
                                    document.getElementById("messages"),
                                    currentOlc.startsWith(
                                        destinationOlc.substring(0, 6),
                                    ),
                                ); // Check if in same 6-char grid
                            } else {
                                document.getElementById("nav2").innerHTML =
                                    "(Invalid OLC entered)";
                                messages(
                                    "geo" + currentOlc.substring(0, 6),
                                    document.getElementById("messages"),
                                    true,
                                ); // Show messages for current location
                            }
                        } else {
                            document.getElementById("nav2").innerHTML =
                                nav2default; // Reset to default if input is empty
                            document.getElementById("navapp").href =
                                "https://www.google.com/maps/@?api=1&map_action=map&center=" +
                                coords.latitude +
                                "," +
                                coords.longitude; // Center map on current location
                            messages(
                                "geo" + currentOlc.substring(0, 6),
                                document.getElementById("messages"),
                                true,
                            ); // Show messages for current location
                            if (location.hash) {
                                // Clear hash if nav input is empty
                                // history.pushState("", document.title, window.location.pathname + window.location.search); // Clears hash without reload
                            }
                        }
                    } catch (e) {
                        console.error(
                            "Error processing navigation/destination:",
                            e,
                        );
                        document.getElementById("nav2").innerHTML = nav2default;
                        messages(
                            "geo" + currentOlc.substring(0, 6),
                            document.getElementById("messages"),
                            true,
                        ); // Fallback to current location messages
                    }
                },
                function (err) {
                    console.warn(
                        "GEOLOCATION ERROR(" + err.code + "): " + err.message,
                    );
                    document.getElementById("accuracy").innerHTML =
                        "Could not get location. Error: " + err.message;
                    // Optionally, try to load messages based on a default or hashed location if geolocation fails
                    let fallbackOlc = location.hash.substring(1) || "8FXC0000+"; // Example default
                    if (OpenLocationCode.isValid(fallbackOlc.toUpperCase())) {
                        messages(
                            "geo" + fallbackOlc.substring(0, 6).toUpperCase(),
                            document.getElementById("messages"),
                            false,
                        );
                    }
                },
                {
                    enableHighAccuracy: true, // Request high accuracy
                    timeout: 10000, // Increased timeout for geolocation
                    maximumAge: 5000, // Allow cached position up to 5 seconds old
                },
            );
        </script>
        <script>
            // register serviceworker

            if ("serviceWorker" in navigator) {
                navigator.serviceWorker
                    .register("service-worker.js")
                    .then(function () {
                        console.log("Service Worker Registered");
                    })
                    .catch(function (err) {
                        console.error(
                            "Service Worker registration failed: ",
                            err,
                        );
                    });
            }
        </script>
    </body>
</html>
